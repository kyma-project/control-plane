openapi: 3.0.0
info:
  description: These APIs allows to manage kyma runtimes through the Kyma Environment Broker. In case of CORS problems use this [Chrome browser extension](https://chrome.google.com/webstore/detail/allow-cors-access-control/lhobafahddgcelffkeicbaginigeejlf) to omit them.
  version: '2.0'
  title: Kyma Environment Broker APIs
  license:
    name: Apache 2.0
    url: 'http://www.apache.org/licenses/LICENSE-2.0.html'
paths:
  /upgrade/kyma:
    post:
      tags:
        - Orchestrations
      summary: orchestrates Kyma upgrade
      operationId: upgradeKyma
      description: Starts the processing of Kyma upgrade, returns the orchestration ID
      responses:
        '202':
          description: Upgrade started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpgradeResponse'
        '400':
          description: Invalid input or object
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestrationError'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrchestrationParameters'
        description: Orchestration parameters to configure orchestration

  /upgrade/cluster:
    post:
      tags:
        - Orchestrations
      summary: orchestrates cluster (shoot) upgrade
      operationId: upgradeCluster
      description: Starts the processing of cluster upgrade, returns the orchestration ID
      responses:
        '202':
          description: Upgrade started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpgradeResponse'
        '400':
          description: Invalid input or object
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestrationError'
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/OrchestrationParameters'
        description: Orchestration parameters to configure orchestration

  /orchestrations:
    get:
      tags:
        - Orchestrations
      summary: returns a list of orchestrations
      operationId: listStatusResponses
      description: |
        Lists all created orchestrations
      parameters:
        - in: query
          name: page_size
          required: false
          schema:
            type: integer
          description: Size of the list
        - in: query
          name: page
          required: false
          schema:
            type: integer
          description: Number of the page
      responses:
        '200':
          description: List of orchestration objects
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponseList'

  /orchestrations/{orchestration_id}:
    get:
      tags:
        - Orchestrations
      summary: returns a single orchestration
      operationId: getOrchestration
      description: |
        Fetches orchestrations by ID
      parameters:
        - in: path
          name: orchestration_id
          required: true
          schema:
            type: string
          description: Orchestration ID
      responses:
        '200':
          description: Orchestration returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/StatusResponse'
        '404':
          description: Orchestration doesn't exist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestrationError'

  /orchestrations/{orchestration_id}/cancel:
    put:
      tags:
        - Orchestrations
      summary: cancels a given in progress or pending orchestration
      operationId: cancelByID
      description: |
        Cancels a given in progress or pending orchestration
      parameters:
        - in: path
          name: orchestration_id
          required: true
          schema:
            type: string
          description: Orchestration ID
      responses:
        '200':
          description: returns Orchestration ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UpgradeResponse'
        '404':
          description: Orchestration doesn't exist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestrationError'

  /orchestrations/{orchestration_id}/operations:
    get:
      tags:
        - Orchestrations
      summary: returns a list of operations scheduled by the orchestration
      operationId: getOperationsPage
      description: |
        Lists operations scheduled by a given orchestration
      parameters:
        - in: path
          name: orchestration_id
          required: true
          schema:
            type: string
          description: Orchestration ID
        - in: query
          name: page_size
          required: false
          schema:
            type: integer
          description: Size of the list
        - in: query
          name: page
          required: false
          schema:
            type: integer
          description: Number of the page
      responses:
        '200':
          description: Operations found and returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OperationResponseList'

  /orchestrations/{orchestration_id}/operations/{operation_id}:
    get:
      tags:
        - Orchestrations
      summary: returns details of the operation scheduled by the orchestration
      operationId: getOperationResponse
      description: |
        Fetches details of the operation with a given ID that was scheduled by the orchestration with a given ID
      parameters:
        - in: path
          name: orchestration_id
          required: true
          schema:
            type: string
          description: Orchestration ID
        - in: path
          name: operation_id
          required: true
          schema:
            type: string
          description: Operation ID
      responses:
        '200':
          description: Operation found and returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OperationDetailsResponse'
        '404':
          description: Operation doesn't exist
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestrationError'

  /runtimes:
    get:
      tags:
        - Runtimes
      summary: returns a list of Runtimes
      operationId: listRuntimes
      description: |
        Lists all Runtimes
      parameters:
        - in: query
          name: page_size
          required: false
          schema:
            type: integer
          description: Size of the list
        - in: query
          name: page
          required: false
          schema:
            type: integer
          description: Number of the page
        - in: query
          name: account
          required: false
          description: Filter by global account ID
          schema:
            type: array
            items:
              type: string
        - in: query
          name: subaccount
          required: false
          description: Filter by subaccount ID
          schema:
            type: array
            items:
              type: string
        - in: query
          name: instance_id
          required: false
          description: Filter by instance ID
          schema:
            type: array
            items:
              type: string
        - in: query
          name: runtime_id
          required: false
          description: Filter by Runtime ID
          schema:
            type: array
            items:
              type: string
        - in: query
          name: region
          required: false
          description: Filter by provider region
          schema:
            type: array
            items:
              type: string
        - in: query
          name: shoot
          required: false
          description: Filter by Shoot name
          schema:
            type: array
            items:
              type: string
        - in: query
          name: state
          required: false
          description: Filter by Runtime state. By default, if no state(s) are provided, suspended Runtimes are filtered out.
          schema:
            type: array
            items:
              type: string
              enum: [
                "succeeded",
                "failed",
                "provisioning",
                "deprovisioning",
                "upgrading",
                "suspended",
                "all"
              ]
      responses:
        '200':
          description: List of Runtimes
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RuntimePage'
        '400':
          description: Wrong parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/OrchestrationError'

  /kubeconfig/{instance_id}:
    get:
      summary: download a kubeconfig for cluster
      tags:
        - Kubeconfig
      parameters:
        - name: instance_id
          in: path
          description: instance id of instance which points to a cluster
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Kubeconfig file will be downloaded
        '400':
          description: Bad request - wrong instanceID
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "mismatch between operation and instance"
        '404':
          description: Instance doesn't exist or is not ready yet
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "kubeconfig for instance <instance_id> does not exist. Provisioning could be in progress, please try again later"
        '500':
          description: Internal error with database or kubeconfig file generator
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: "cannot fetch SKR kubeconfig: builder error"

  /oauth/v2/catalog:
    get:
      summary: get the catalog of services that the service broker offers
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Catalog
      operationId: catalog.get
      parameters:
        - $ref: '#/components/parameters/APIVersion'
      responses:
        '200':
          description: catalog response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Catalog'

  /oauth/v2/service_instances/{instance_id}:
    put:
      summary: provision a service instance
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Instances
      operationId: serviceInstance.provision
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: instance_id
          in: path
          description: instance id of instance to provision
          required: true
          schema:
            type: string
      requestBody:
        description: parameters for the requested service instance provision
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceInstanceProvisionRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceInstanceProvision'
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceInstanceProvision'
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceInstanceAsyncOperation'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: Unprocessable Entity
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    patch:
      summary: update a service instance
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Instances (not implemented)
      operationId: serviceInstance.update
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: instance_id
          in: path
          description: instance id of instance to update
          required: true
          schema:
            type: string
      requestBody:
        description: parameters for the requested service instance update
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceInstanceUpdateRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Object'
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceInstanceAsyncOperation'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: Unprocessable entity
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      summary: deprovision a service instance
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Instances
      operationId: serviceInstance.deprovision
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: instance_id
          in: path
          description: id of instance being deleted
          required: true
          schema:
            type: string
        - name: service_id
          in: query
          description: id of the service associated with the instance being deleted
          required: true
          schema:
            type: string
        - name: plan_id
          in: query
          description: id of the plan associated with the instance being deleted
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Object'
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AsyncOperation'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '410':
          description: Gone
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: Unprocessable Entity
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    get:
      summary: gets a service instance
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Instances
      operationId: serviceInstance.get
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: instance_id
          in: path
          description: instance id of instance to fetch
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceInstanceResource'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /oauth/v2/service_instances/{instance_id}/last_operation:
    get:
      summary: last requested operation state for service instance
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Instances
      operationId: serviceInstance.lastOperation.get
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: instance_id
          in: path
          description: instance id of instance to find last operation applied to it
          required: true
          schema:
            type: string
        - name: service_id
          in: query
          description: id of the service associated with the instance
          schema:
            type: string
        - name: plan_id
          in: query
          description: id of the plan associated with the instance
          schema:
            type: string
        - name: operation
          in: query
          description: a provided identifier for the operation
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LastOperationResource'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '410':
          description: Gone
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /oauth/v2/service_instances/{instance_id}/service_bindings/{binding_id}/last_operation:
    get:
      summary: last requested operation state for service binding
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Bindings (not implemented)
      operationId: serviceBinding.lastOperation.get
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: instance_id
          in: path
          description: instance id of instance to find last operation applied to it
          required: true
          schema:
            type: string
        - name: binding_id
          in: path
          description: binding id of service binding to find last operation applied to it
          required: true
          schema:
            type: string
        - name: service_id
          in: query
          description: id of the service associated with the instance
          schema:
            type: string
        - name: plan_id
          in: query
          description: id of the plan associated with the instance
          schema:
            type: string
        - name: operation
          in: query
          description: a provided identifier for the operation
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LastOperationResource'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '410':
          description: Gone
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /oauth/v2/service_instances/{instance_id}/service_bindings/{binding_id}:
    put:
      summary: generation of a service binding
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Bindings (not implemented)
      operationId: serviceBinding.binding
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: instance_id
          in: path
          description: instance id of instance to create a binding on
          required: true
          schema:
            type: string
        - name: binding_id
          in: path
          description: binding id of binding to create
          required: true
          schema:
            type: string
        - name: accepts_incomplete
          in: query
          description: asynchronous operations supported
          schema:
            type: boolean
      requestBody:
        description: parameters for the requested service binding
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceBindingRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceBinding'
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceBinding'
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AsyncOperation'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: Unprocessable Entity
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      summary: deprovision of a service binding
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Bindings (not implemented)
      operationId: serviceBinding.unbinding
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: instance_id
          in: path
          description: id of the instance associated with the binding being deleted
          required: true
          schema:
            type: string
        - name: binding_id
          in: path
          description: id of the binding being deleted
          required: true
          schema:
            type: string
        - name: service_id
          in: query
          description: id of the service associated with the instance for which a binding is being deleted
          required: true
          schema:
            type: string
        - name: plan_id
          in: query
          description: id of the plan associated with the instance for which a binding is being deleted
          required: true
          schema:
            type: string
        - name: accepts_incomplete
          in: query
          description: asynchronous operations supported
          schema:
            type: boolean
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Object'
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AsyncOperation'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '410':
          description: Gone
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    get:
      summary: gets a service binding
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Bindings (not implemented)
      operationId: serviceBinding.get
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: instance_id
          in: path
          description: instance id of instance associated with the binding
          required: true
          schema:
            type: string
        - name: binding_id
          in: path
          description: binding id of binding to fetch
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceBindingResource'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /oauth/{region}/v2/catalog:
    get:
      summary: get the catalog of services that the service broker offers
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Catalog
      operationId: catalog.region.get
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: region
          in: path
          description: the region id
          required: true
          schema:
            type: string
      responses:
        '200':
          description: catalog response
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Catalog'

  /oauth/{region}/v2/service_instances/{instance_id}:
    put:
      summary: provision a service instance
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Instances
      operationId: serviceInstance.region.provision
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: region
          in: path
          description: the region id
          required: true
          schema:
            type: string
        - name: instance_id
          in: path
          description: instance id of instance to provision
          required: true
          schema:
            type: string
      requestBody:
        description: parameters for the requested service instance provision
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceInstanceProvisionRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceInstanceProvision'
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceInstanceProvision'
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceInstanceAsyncOperation'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: Unprocessable Entity
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    patch:
      summary: update a service instance
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Instances (not implemented)
      operationId: serviceInstance.region.update
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: region
          in: path
          description: the region id
          required: true
          schema:
            type: string
        - name: instance_id
          in: path
          description: instance id of instance to update
          required: true
          schema:
            type: string
      requestBody:
        description: parameters for the requested service instance update
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceInstanceUpdateRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Object'
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceInstanceAsyncOperation'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: Unprocessable entity
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      summary: deprovision a service instance
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Instances
      operationId: serviceInstance.region.deprovision
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: region
          in: path
          description: the region id
          required: true
          schema:
            type: string
        - name: instance_id
          in: path
          description: id of instance being deleted
          required: true
          schema:
            type: string
        - name: service_id
          in: query
          description: id of the service associated with the instance being deleted
          required: true
          schema:
            type: string
        - name: plan_id
          in: query
          description: id of the plan associated with the instance being deleted
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Object'
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AsyncOperation'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '410':
          description: Gone
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: Unprocessable Entity
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    get:
      summary: gets a service instance
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Instances
      operationId: serviceInstance.region.get
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: region
          in: path
          description: the region id
          required: true
          schema:
            type: string
        - name: instance_id
          in: path
          description: instance id of instance to fetch
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceInstanceResource'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /oauth/{region}/v2/service_instances/{instance_id}/last_operation:
    get:
      summary: last requested operation state for service instance
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Instances
      operationId: serviceInstance.region.lastOperation.get
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: region
          in: path
          description: the region id
          required: true
          schema:
            type: string
        - name: instance_id
          in: path
          description: instance id of instance to find last operation applied to it
          required: true
          schema:
            type: string
        - name: service_id
          in: query
          description: id of the service associated with the instance
          schema:
            type: string
        - name: plan_id
          in: query
          description: id of the plan associated with the instance
          schema:
            type: string
        - name: operation
          in: query
          description: a provided identifier for the operation
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LastOperationResource'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '410':
          description: Gone
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /oauth/{region}/v2/service_instances/{instance_id}/service_bindings/{binding_id}/last_operation:
    get:
      summary: last requested operation state for service binding
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Bindings (not implemented)
      operationId: serviceBinding.region.lastOperation.get
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: region
          in: path
          description: the region id
          required: true
          schema:
            type: string
        - name: instance_id
          in: path
          description: instance id of instance to find last operation applied to it
          required: true
          schema:
            type: string
        - name: binding_id
          in: path
          description: binding id of service binding to find last operation applied to it
          required: true
          schema:
            type: string
        - name: service_id
          in: query
          description: id of the service associated with the instance
          schema:
            type: string
        - name: plan_id
          in: query
          description: id of the plan associated with the instance
          schema:
            type: string
        - name: operation
          in: query
          description: a provided identifier for the operation
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LastOperationResource'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '410':
          description: Gone
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /oauth/{region}/v2/service_instances/{instance_id}/service_bindings/{binding_id}:
    put:
      summary: generation of a service binding
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Bindings (not implemented)
      operationId: serviceBinding.region.binding
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: region
          in: path
          description: the region id
          required: true
          schema:
            type: string
        - name: instance_id
          in: path
          description: instance id of instance to create a binding on
          required: true
          schema:
            type: string
        - name: binding_id
          in: path
          description: binding id of binding to create
          required: true
          schema:
            type: string
        - name: accepts_incomplete
          in: query
          description: asynchronous operations supported
          schema:
            type: boolean
      requestBody:
        description: parameters for the requested service binding
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ServiceBindingRequest'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceBinding'
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceBinding'
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AsyncOperation'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Conflict
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '422':
          description: Unprocessable Entity
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      summary: deprovision of a service binding
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Bindings (not implemented)
      operationId: serviceBinding.region.unbinding
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: region
          in: path
          description: the region id
          required: true
          schema:
            type: string
        - name: instance_id
          in: path
          description: id of the instance associated with the binding being deleted
          required: true
          schema:
            type: string
        - name: binding_id
          in: path
          description: id of the binding being deleted
          required: true
          schema:
            type: string
        - name: service_id
          in: query
          description: id of the service associated with the instance for which a binding is being deleted
          required: true
          schema:
            type: string
        - name: plan_id
          in: query
          description: id of the plan associated with the instance for which a binding is being deleted
          required: true
          schema:
            type: string
        - name: accepts_incomplete
          in: query
          description: asynchronous operations supported
          schema:
            type: boolean
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Object'
        '202':
          description: Accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AsyncOperation'
        '400':
          description: Bad Request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '410':
          description: Gone
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    get:
      summary: gets a service binding
      security:
        - oAuth2ClientCredentials: [broker:write]
      tags:
        - Bindings (not implemented)
      operationId: serviceBinding.region.get
      parameters:
        - $ref: '#/components/parameters/APIVersion'
        - name: region
          in: path
          description: the region id
          required: true
          schema:
            type: string
        - name: instance_id
          in: path
          description: instance id of instance associated with the binding
          required: true
          schema:
            type: string
        - name: binding_id
          in: path
          description: binding id of binding to fetch
          required: true
          schema:
            type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceBindingResource'
        '404':
          description: Not Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

components:
  parameters:
    APIVersion:
      name: X-Broker-API-Version
      in: header
      description: version number of the Service Broker API that the Platform will use
      required: true
      schema:
        type: string
        default: '2.14'

  schemas:
    OrchestrationParameters:
      type: object
      properties:
        strategy:
          type: object
          properties:
            type:
              type: string
              example: parallel
              enum: [
                  "parallel"
              ]
              description: "Specifies the type of the orchestration"
            schedule:
              type: string
              enum: [
                  "immediate",
                  "maintenanceWindow"
              ]
              example: immediate
              description: "Specifies the schedule type for an orchestration"
            parallel:
              type: object
              properties:
                workers:
                  type: number
                  example: 1
                  description: Specifies the number of parallel workers to process upgrade operations
        dryRun:
          type: boolean
          default: false
          description: Specifies if the orchestration is used for testing purposes
        version:
          type: string
          example: 1.18.0|PR-123|main-00e83e99
          description: Specifies Kyma version for the upgrade operation. Supports semantic, PR, and branch-commit as Kyma version.
        targets:
          type: object
          properties:
            include:
              type: array
              items:
                $ref: '#/components/schemas/RuntimeTarget'
            exclude:
              type: array
              items:
                $ref: '#/components/schemas/RuntimeTarget'

    RuntimeTarget:
      type: object
      properties:
        target:
          type: string
          enum: [
              "all"
          ]
          example: all
          description: "Selects Runtimes in a specified way"
        globalAccount:
          type: string
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
          description: Regex pattern to match against Runtime's globalAccount field
        subAccount:
          type: string
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
          description: Regex pattern to match against Runtime's subAccount field
        region:
          type: string
          example: europe|eu-
          description: Regex pattern to match against the Shoot cluster's region field (not SCP platform region)
        runtimeID:
          type: string
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
          description: Specifies runtimeID
        planName:
          type: string
          example: azure
          description: Specifies plan name
        shoot:
          type: string
          example: c-0ab3fe0
          description: Match Runtime by shoot name

    StatusResponse:
      type: object
      properties:
        type:
          type: string
          enum: [
            "upgradeKyma",
            "upgradeCluster"
          ]
          description: "Orchestration type, either kyma upgrade or cluster upgrade"
          example: "upgradeKyma"
        state:
          type: string
          example: in progress
        description:
          type: string
          example: Orchestration scheduled
        parameters:
          $ref: '#/components/schemas/OrchestrationParameters'
        operationStats:
          type: object
          description: Number of operations per operation state
          additionalProperties:
            type: integer

    StatusResponseList:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/StatusResponse'
        count:
          type: integer
          example: 0
        totalCount:
          type: integer
          example: 0

    OperationResponse:
      type: object
      properties:
        instanceID:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        runtimeID:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        operationID:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        globalAccountID:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        subAccountID:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        state:
          type: string
          example: in progress
          enum: [
              "suceeded",
              "failed",
              "in progress"
          ]
        description:
          type: string
          example: Operation scheduled
        shootName:
          type: string
          example: c-8e9ea4f
          description: Name of the Shoot cluster on Gardener
        maintenanceWindowBegin:
          type: string
          example: 150405-0000
          description: Start time of the orchestrations processing
        maintenanceWindowEnd:
          type: string
          example: 160405-0000
          description: Orchestrations processing deadline
        dryRun:
          type: boolean
          default: false
          description: Specifies if the orchestration is used for testing purposes
        servicePlanID:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
          description: ID of the service plan
        servicePlanName:
          type: string
          example: azure
          description: Specifies the plan name

    OperationDetailsResponse:
      type: object
      properties:
        instanceID:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        runtimeID:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        operationID:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        globalAccountID:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        subAccountID:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        state:
          type: string
          enum: [
              "suceeded",
              "failed",
              "in progress"
          ]
          example: in progress
        description:
          type: string
          example: Operation scheduled
        shootName:
          type: string
          example: c-8e9ea4f
          description: Name of the Shoot cluster on Gardener
        maintenanceWindowBegin:
          type: string
          example: 150405-0000
          description: Start time of the orchestrations processing
        maintenanceWindowEnd:
          type: string
          example: 160405-0000
          description: Orchestrations processing deadline
        dryRun:
          type: boolean
          default: false
          description: Specifies if the orchestration is used for testing purposes
        servicePlanID:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
          description: ID of the service plan
        servicePlanName:
          type: string
          example: azure
          description: Specifies the plan name
        kymaConfig:
          type: string
          description: Object with the Kyma config sent to Runtime Provisioner
        clusterConfig:
          type: string
          description: Object with the cluster config sent to Runtime Provisioner

    OperationResponseList:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/OperationResponse'
        count:
          type: integer
          example: 0
        totalCount:
          type: integer
          example: 0

    UpgradeResponse:
      type: object
      properties:
        orchestrationID:
          type: string
          example: 054ac2c2-318f-45dd-855c-eee41513d40d

    RuntimeDTO:
      type: object
      properties:
        instanceID:
          type: string
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        runtimeID:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        globalAccountID:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        subaccountID:
          type: string
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        subaccountRegion:
          type: string
        shootName:
          type: string
          example: c-8e9ea4f
          description: Name of the Shoot cluster on Gardener
        serviceClassID:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        serviceClassName:
          type: string
          example: kymaruntime
        servicePlanID:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        servicePlanName:
          type: string
          example: azure
        status:
          $ref: '#/components/schemas/StatusDTO'

    RuntimePage:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/RuntimeDTO'
        count:
          type: integer
          example: 0
        totalCount:
          type: integer
          example: 0

    StatusDTO:
      type: object
      properties:
        createdAt:
          type: string
          format: timestamp
        modifiedAt:
          type: string
          format: timestamp
        provisioning:
          $ref: '#/components/schemas/OperationStateDTO'
        deprovisioning:
          $ref: '#/components/schemas/OperationStateDTO'
        upgradingKyma:
          $ref: '#/components/schemas/OperationsDataDTO'
        suspension:
          $ref: '#/components/schemas/OperationsDataDTO'
        unsuspension:
          $ref: '#/components/schemas/OperationsDataDTO'

    OperationStateDTO:
      type: object
      properties:
        state:
          type: string
          example: in progress
          enum: [
              "suceeded",
              "failed",
              "in progress"
          ]
        description:
          type: string
          example: Operation scheduled
        createdAt:
          type: string
          format: timestamp
        operationID:
          type: string
          format: uuid

    OperationsDataDTO:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/OperationStateDTO'
        count:
          type: integer
        totalCount:
          type: integer

    OrchestrationError:
      type: object
      properties:
        error:
          type: string
          example: "while decoding request body: invalid character '}' looking for beginning of object key string"

    Catalog:
      type: object
      properties:
        services:
          type: array
          items:
            $ref: '#/components/schemas/Service'

    Service:
      type: object
      required:
        - name
        - id
        - description
        - bindable
        - plans
      properties:
        name:
          type: string
          example: kymaruntime
          description: Service's name
        id:
          type: string
          format: uuid
          example: 47c9dcbf-ff30-448e-ab36-d3bad66ba281
          description: Service's ID
        description:
          type: string
          example: Kyma environment is a runtime you can use to build cloud-native Kubernetes-based applications by using microservices and serverless functions.
          description: Service's description
        tags:
          type: array
          items:
            type: string
        bindable:
          type: boolean
          description: Specifies if service is bindable
          default: true
        metadata:
          $ref: '#/components/schemas/ServiceMetadata'
        plan_updateable:
          type: boolean
          description: Specifies if plan can be updated
          default: false
        plans:
          type: array
          items:
            $ref: '#/components/schemas/Plan'

    Plan:
      type: object
      required:
        - id
        - name
        - description
      properties:
        id:
          type: string
          format: uuid
          example: 47c9dcbf-ff30-448e-ab36-d3bad66ba281
          description: Service's plan ID
        name:
          type: string
          example: azure
          description: Service's plan name
        description:
          type: string
          example: Azure
          description: Service's plan description
        metadata:
          $ref: '#/components/schemas/PlanMetadata'
        bindable:
          type: boolean
          default: true
          description: Specifies if plan is bindable
        schemas:
          $ref: '#/components/schemas/Schemas'

    Schemas:
      type: object
      properties:
        service_instance:
          $ref: '#/components/schemas/ServiceInstanceSchema'
        service_binding:
          $ref: '#/components/schemas/ServiceBindingSchema'

    ServiceInstanceSchema:
      type: object
      properties:
        create:
          $ref: '#/components/schemas/SchemaParameters'
        update:
          $ref: '#/components/schemas/SchemaParameters'

    ServiceBindingSchema:
      type: object
      properties:
        create:
          $ref: '#/components/schemas/SchemaParameters'

    SchemaParameters:
      type: object
      properties:
        parameters:
          type: object

    ServiceInstanceResource:
      type: object
      properties:
        service_id:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        plan_id:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        dashboard_url:
          type: string
          example: https://dashboard.kyma.com
        parameters:
          $ref: '#/components/schemas/Object'

    ServiceInstanceProvisionRequest:
      type: object
      required:
        - service_id
        - plan_id
      properties:
        service_id:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        plan_id:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        context:
          $ref: '#/components/schemas/Context'
        parameters:
          $ref: '#/components/schemas/Object'

    ServiceInstanceProvision:
      type: object
      properties:
        dashboard_url:
          type: string
          example: https://dashboard.kyma.com

    ServiceInstanceAsyncOperation:
      type: object
      properties:
        dashboard_url:
          type: string
          example: https://dashboard.kyma.com
        operation:
          type: string # could be a link object to last operation

    ServiceInstanceUpdateRequest:
      type: object
      required:
        - service_id
      properties:
        context:
          $ref: '#/components/schemas/Context'
        service_id:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        plan_id:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        parameters:
          $ref: '#/components/schemas/Object'
        previous_values:
          $ref: '#/components/schemas/ServiceInstancePreviousValues'

    ServiceInstancePreviousValues:
      type: object
      properties:
        plan_id:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d

    AsyncOperation:
      type: object
      properties:
        operation:
          type: string

    LastOperationResource:
      type: object
      required:
        - state
      properties:
        state:
          type: string
          enum:
            - in progress
            - succeeded
            - failed
        description:
          type: string

    ServiceBindingResource:
      type: object
      properties:
        credentials:
          $ref: '#/components/schemas/Object'
        syslog_drain_url:
          type: string
        route_service_url:
          type: string
        volume_mounts:
          type: array
          items:
            $ref: '#/components/schemas/ServiceBindingVolumeMount'
        parameters:
          $ref: '#/components/schemas/Object'

    ServiceBindingRequest:
      type: object
      required:
        - service_id
        - plan_id
      properties:
        context:
          $ref: '#/components/schemas/Context'
        service_id:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        plan_id:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        parameters:
          $ref: '#/components/schemas/Object'

    ServiceBinding:
      type: object
      properties:
        credentials:
          $ref: '#/components/schemas/Object'
        syslog_drain_url:
          type: string
        route_service_url:
          type: string
        volume_mounts:
          type: array
          items:
            $ref: '#/components/schemas/ServiceBindingVolumeMount'

    ServiceBindingVolumeMount:
      type: object
      required:
        - driver
        - container_dir
        - mode
        - device_type
        - device
      properties:
        driver:
          type: string
        container_dir:
          type: string
        mode:
          type: string
          enum:
            - r
            - rw
        device_type:
          type: string
          enum:
            - shared
        device:
          $ref: '#/components/schemas/ServiceBindingVolumeMountDevice'

    ServiceBindingVolumeMountDevice:
      type: object
      required:
        - volume_id
      properties:
        volume_id:
          type: string
        mount_config:
          $ref: '#/components/schemas/Object'

    Context:
      description: "See [Context Conventions](https://github.com/openservicebrokerapi/servicebroker/blob/master/profile.md#context-object) for more details."
      type: object
      properties:
        globalaccount_id:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d
        subaccount_id:
          type: string
          format: uuid
          example: 054ac2c2-318f-45dd-855c-eee41513d40d

    ServiceMetadata:
      description: "See [Service Metadata Conventions](https://github.com/openservicebrokerapi/servicebroker/blob/master/profile.md#service-metadata) for more details."
      type: object
      properties:
        displayName:
          type: string
          example: Kyma Environment
        documentationUrl:
          type: string
          example: https://github.com/kyma-project/control-plane/tree/main/docs/kyma-environment-broker
        imageUrl:
          type: string
          example: data:image/svg+xml;base64,imgURL
        longDescription:
          type: string
          example: Kyma environment is a runtime you can use to build cloud-native Kubernetes-based applications by using microservices and serverless functions.
        providerDisplayName:
          type: string
          example: provider
        supportUrl:
          type: string
          example: https://support.com/

    PlanMetadata:
      description: "See [Service Metadata Conventions](https://github.com/openservicebrokerapi/servicebroker/blob/master/profile.md#service-metadata) for more details."
      type: object
      properties:
        displayName:
          type: string
          example: Azure

    Object:
      type: object

    Error:
      description: "See [Service Broker Errors](https://github.com/openservicebrokerapi/servicebroker/blob/master/spec.md#service-broker-errors) for more details."
      type: object
      properties:
        error:
          type: string
          example: not found error
        description:
          type: string
          example: instance was not found
  securitySchemes:
    oAuth2ClientCredentials:
      type: oauth2
      flows:
        clientCredentials:
          tokenUrl: https://oauth2.{{.domain}}/oauth2/token
          scopes:
            broker:write: Grants access to OSB API

externalDocs:
  description: The offical Kyma Environment Broker documentation
  url: 'https://github.com/kyma-project/control-plane/tree/main/docs/kyma-environment-broker'